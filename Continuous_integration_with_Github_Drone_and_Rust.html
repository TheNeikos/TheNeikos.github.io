<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Continuous Integration with Github and Drone for Rust Projects</title><style>html body{font-family:raleway,sans-serif;background-color:#fff}:root{--accent: green;--border-width:  5px }</style><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><script type=text/javascript>var _paq=_paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){_paq.push(['setTrackerUrl','https://api-1ae8886f4428fee007ebf3e570e5c1e3.hemera.sandcats.io']);_paq.push(['setSiteId',1]);_paq.push(['setApiToken','f33SDEYp33zx4vFBTZdm13NtTK9Ksd93EDx2kT1e982']);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.type='text/javascript';g.async=true;g.defer=true;g.src='https://md6h0twa65rihzm46p0e.hemera.sandcats.io/embed.js';s.parentNode.insertBefore(g,s);})();</script><meta name=generator content="Hugo 0.80.0"></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>Continuous Integration with Github and Drone for Rust Projects</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><a href=/project/>Projects</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:neikos@neikos.email><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/TheNeikos/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=https://stackoverflow.com/users/783825/neikos><i class="fa fa-stack-overflow"></i></a></li><li class=navbar-icon><a href=https://telegram.me/TheNeikos><i class="fa fa-telegram"></i></a></li></ul></div></div></nav><main><div class=item><h4><a href=/Continuous_integration_with_Github_Drone_and_Rust.html>Continuous Integration with Github and Drone for Rust Projects</a></h4><h5>October 21, 2015</h5></div><br><div class=text-justify><p>The combination of Github and Drone (or any other CI) is quite powerful when it
comes to assuring that your pull requests are not breaking any existing tests.</p><p>For those who have never heard of Drone: <a href=https://drone.io>Drone</a> is an
open source CI Server that is easy to install and compatible with lots of
different services. You can check out the <a href=https://github.com/drone/drone>repo, it&rsquo;s on Github as well.</a></p><p>In this Blog post I will show you how to get from 0 to a github repository with
tests for a rust library.</p><p><strong>The Result we want to have:</strong></p><ol><li>Protected Master Branch</li><li>Tests are automatically run for all pull requests</li><li>Pull Requests have to pass all tests</li></ol><p><strong>Pre-requisites</strong></p><ul><li>A working Ubuntu 14.04 Server with the latest updates</li><li>A basic understanding of the Linux shell Bash</li><li>A basic understanding of Docker</li><li>A basic understanding of git</li><li>A Github account</li></ul><h2 id=getting-started>Getting Started</h2><h3 id=drone>Drone</h3><p>First we will install drone on the Ubuntu server, so log in there.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>clouduser@drone-test:~$</code></pre></div><p>Alright! Now let&rsquo;s get started:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>clouduser@drone-test:~$ sudo apt-get update
/ ..things.. /
clouduser@drone-test:~$ sudo apt-get install docker.io</code></pre></div><p>Once that is done we can install drone itself!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>clouduser@drone-test:~$ wget downloads.drone.io/master/drone.deb
clouduser@drone-test:~$ sudo dpkg --install drone.deb</code></pre></div><p>Now go checkout <code>http://yourip/</code>. It should display a link to the setup guide.
If you wish to also have SSL enable you should check it out, but otherwise this
post will also tell you the next steps.</p><p>Do not close the connection yet as we will have to fill the config in the next
step.</p><h3 id=connecting-github-to-drone>Connecting Github to Drone</h3><p>We now have to create a new Developer Application in Github, thankfully this is
rather easy. Go to: <a href=https://github.com/settings/developers>https://github.com/settings/developers</a> and click on
<strong>&ldquo;Register new application&rdquo;</strong> at the top right.</p><p>Now fill out the fields:</p><p><img src=https://i.imgur.com/bDpQQM9.png alt></p><p>Once you have registered the Application it will show you more information.</p><p>There you will find two important fields:</p><ul><li><strong>Client ID</strong></li><li><strong>Client Secret</strong></li></ul><p>Go back to your drone server and open <code>/etc/drone/drone.toml</code> as root with your
favorite editor and look for <code>[github]</code> and uncomment these lines:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[<span style=color:#a6e22e>github</span>]
<span style=color:#a6e22e>client</span>=<span style=color:#e6db74>&#34;&#34;</span>
<span style=color:#a6e22e>secret</span>=<span style=color:#e6db74>&#34;&#34;</span></code></pre></div><p>Now you can fill those fields with the information from your github. Then save
and you can close the file. Now we restart the drone server so that it reads
the new configuration.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>clouduser@drone-test:~$ sudo restart drone</code></pre></div><p>You should now be greeted with a Github icon, allowing
you to sign in!</p><p>We now have a drone server up and running and we have it linked with Github,
now let&rsquo;s create a Rust library that we can test!</p><h3 id=rust-library>Rust Library</h3><p>If you still have the drone server open you may now close the connection.</p><p>If you have a place where you usually create projects go there now and then
let&rsquo;s create a new cargo lib.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/p/rust $ cargo new awesome_lib</code></pre></div><p>We then create the first commit inside the new lib:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/p/rust $ cd awesome_lib
~/p/r/awesome_lib <span style=color:#f92672>(</span>master<span style=color:#f92672>)</span>$ git add .
~/p/r/awesome_lib <span style=color:#f92672>(</span>master<span style=color:#f92672>)</span>$ git commit -m <span style=color:#e6db74>&#34;Initial Commit&#34;</span>
<span style=color:#f92672>[</span>master <span style=color:#f92672>(</span>root-commit<span style=color:#f92672>)</span> a0b044a<span style=color:#f92672>]</span> Initial Commit</code></pre></div><p>Now let&rsquo;s create the github repo. Let&rsquo;s go to <a href=https://github.com/new>https://github.com/new</a> and create the
repo.</p><p><img src=https://i.imgur.com/owN2yXK.png alt></p><p>Once that is done we will tell our local repository that there is an upstream
repository. (Basically the &lsquo;push an existing repository&rsquo;)
Before copying the commands be sure to use ssh so that you authenticate through
that instead of typing your username/password everytime. (It can get annoying
quickly.)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/p/rust $ git remote add origin git@github.com:&lt;yourusername&gt;/awesome_lib.git
~/p/rust $ git push origin master</code></pre></div><p>Awesome! We now get to the interesting parts.</p><h3 id=adding-the-repository-to-drone>Adding the repository to drone</h3><p>Navigate to the drone instance you have setup earlier in your browser, login and
press the &lsquo;sync&rsquo; button at the top right. This is needed in case Drone does not
pick up on the repository right away. Click on &lsquo;Browse&rsquo; and look for
&lsquo;awesome_lib&rsquo;, click on it and then press the &ldquo;Activate Now&rdquo; button.</p><p>Once loading process is done let&rsquo;s create the <code>.drone.yml</code> file so that the
server actually knows what&rsquo;s up!</p><h3 id=creating-the-droneyml-file>Creating the .drone.yml file</h3><p>In your local awesome_lib directory create a .drone.yml</p><p>Be sure to replace your docker name correctly, feel also free to update the rust
version should yours differ (it probably will in the future)</p><p>If you don&rsquo;t have a docker account yet you can create one
<a href=https://docs.docker.com/docker-hub/accounts/>here</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>image</span>: <span style=color:#ae81ff>&lt;your docker name&gt;/rust:1.3</span>
<span style=color:#f92672>env</span>:
- <span style=color:#ae81ff>CARGO_TARGET_DIR=/var/cache/drone/cargo</span>
- <span style=color:#ae81ff>CARGO_HOME=/var/cache/drone/cargo</span>
<span style=color:#f92672>script</span>:
- <span style=color:#ae81ff>cargo build</span>
- <span style=color:#ae81ff>cargo test</span>
<span style=color:#f92672>cache</span>:
- <span style=color:#ae81ff>/var/cache/drone/cargo</span></code></pre></div><p>Then we create a new branch and add our changes to that and push them!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/p/r/awesome_lib <span style=color:#f92672>(</span>master<span style=color:#f92672>)</span>$ git checkout -b add-drone
~/p/r/awesome_lib <span style=color:#f92672>(</span>add-drone<span style=color:#f92672>)</span>$ git add .drone.yml
~/p/r/awesome_lib <span style=color:#f92672>(</span>add-drone<span style=color:#f92672>)</span>$ git commit -m <span style=color:#e6db74>&#34;Add .drone.yml&#34;</span></code></pre></div><p>Perfect. Now let&rsquo;s make that pull request! If you go back to your repo on Github
it should tell you that you can create a Pull Request.</p><p>Afterwards it should load and quickly tell you that it has failed, the reason is
simply that the image does not exist yet, let&rsquo;s do that now!</p><h3 id=creating-the-docker-image>Creating the Docker Image</h3><p>Okay, so let&rsquo;s create a dockerfile that will allow us to have cargo and rust.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>FROM ubuntu:15.04

RUN apt-get install curl file git build-essential -y &amp;&amp; \
    curl -sSf https://static.rust-lang.org/rustup.sh \
    | sh -s -- -y --disable-sudo
</code></pre></div><p>If you need any additional (non-rust) libraries be sure to install them here too!
Or your build will fail later on. If you are unsure what libraries are needed then
check out the sources first (or perhaps they have their own CI and signal which
libraries are needed.) As a last recourse you could always open an issue on
their site, shoot a mail or otherwise contact them.</p><p>Then we build it!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/t/rust_image&gt; docker build .</code></pre></div><p>It should finish with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>    Rust is ready to roll.

 ---&gt; bc9ad00de680
Removing intermediate container 040774e66535
Successfully built bc9ad00de680</code></pre></div><p>In that last line is an id, we will need that in the next step, copy it and
put it in the next command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/t/rust_image&gt; docker tag &lt;THE_ID&gt; &lt;DOCKER_USERNAME&gt;/rust:1.3</code></pre></div><p>Then we upload it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~/t/rust_image&gt; docker push neikos/rust:1.3</code></pre></div><p>Now we restart the drone build. Click on the red cross next to your commit
in your pull request on Github. It should take you to your drone server. And if
you are logged in, you should be able to click on &lsquo;rebuild&rsquo; to kick off the
build again.</p><p>The first time this runs might take a bit longer as the image will have to be
downloaded first, subsequent builds should be faster. On my virtual machine it
takes about 1-2 minutes.</p><p><img src=https://i.imgur.com/cET7COE.png alt></p><p>At the end it should tell you that it passed, you can then go back to you Github
and start using it! Or secure it a bit more against accidental merges.</p><h3 id=forcing-checks-before-merge>Forcing checks before merge</h3><p>Navigate to your github repository and click on settings on the bottom left, then go
to the branches tab and &lsquo;protect&rsquo; the <code>master</code> branch.</p><p>Then you can re-affirm that you want to protect the branch and require status
checks before merging. I like to include administrators as they can
write code that is just as bad as the average person :) .</p><p>Don&rsquo;t forget to check Drone at the bottom to make it <strong>required</strong>.</p><p>And that&rsquo;s it! Feel free to start writing tests and make pull requests! From now
on they will always be checked and you shouldn&rsquo;t have any failing tests in your
master branch, isn&rsquo;t that awesome!</p><p>If you need any additional dependencies you can add them to the dockerfile and
update the image.</p></div></main><footer><p class="copyright text-muted">© All rights reserved. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/calintat/minimal>Minimal</a></p></footer></body></html>